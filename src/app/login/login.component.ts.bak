import { Component, OnInit } from '@angular/core';
import { FormBuilder, Validators, FormGroup, FormControl } from '@angular/forms';
import { Router } from '@angular/router';
import { Patterns } from 'global-constants';
import * as moment from 'moment';
import { ConfigService } from '../services/config.service';
import { LoaderService } from '../services/loader.service';
declare var $: any;

@Component({
  selector: 'app-login',
  templateUrl: './login.component.html',
  styleUrls: ['./login.component.scss']
})
export class LoginComponent implements OnInit {

  loginForm: any;
  otpDetails: any;
  selectedLang: any;
  position!: number;
  showLogin: boolean = true;
  apiResponse: any = {};
  isSubmitted: boolean = false;
  locationList: any;
  doctorDetails: any;
  errorMessage: any;
  location: any;

  otp = {
    one: "",
    two: "",
    three: "",
    four: ""
  }
  patientInfo: any;
  listOfLanguages = [
    { Id: 1, value: "English", code: "en" },
    { Id: 2, value: "Arabic", code: "ar" }
  ]
  timeLeft: number = 60;
  interval: any;
  showResendOTP: boolean = false;
  currentdate: any;
  currenttime: any;
  datetime: any;
  loginLangData: any;
  constructor(private fb: FormBuilder, private config: ConfigService, private router: Router, private loader: LoaderService) {
    this.config.onLogout();
    if ("lang" in localStorage) {
      let langCode = localStorage.getItem('lang');
      if (langCode === "en") {
        this.selectedLang = { Id: 1, value: "English", code: "en" };
      } else if (langCode === "ar") {
        this.selectedLang = { Id: 2, value: "Arabic", code: "ar" };
      }
      this.loader.setDefaultLangCode(langCode);
      console.log("Already lang code existed");
      this.getSelectedLangData(langCode);
      this.getDate(langCode);
    } else {
      this.selectedLang = { Id: 1, value: "English", code: "en" };
      localStorage.setItem("lang", `${this.selectedLang.code}`);
      this.loader.setDefaultLangCode(this.selectedLang.code);
      this.getSelectedLangData(this.selectedLang.code);
      this.getDate(this.selectedLang.code);
    }
    this.position = 1;
  }

  ngOnInit(): void {
    this.loginForm = this.fb.group({
      UserName: ['', Validators.required],
      Password: ['', Validators.required],
      Location: ['', Validators.required]
    });
    this.FetchFetchHospitalLocations();
  }

  FetchFetchHospitalLocations() {
    this.config.fetchFetchHospitalLocations().subscribe((response) => {
      if (response.Status === "Success") {
        this.locationList = response.HospitalLocationsDataList;
        if (response.HospitalLocationsDataList.length == 1) {
          this.loginForm.get('Location')?.setValue(response.HospitalLocationsDataList[0].HospitalID);
        }
      } else {
      }
    },
      (err) => {

      })
  }

  onSubmit(): void {

    if (this.loginForm.valid) {
      this.isSubmitted = false;
      this.validateDoctorLogin();
     
    } else {
      this.showLogin = true;
      this.isSubmitted = true;
    }

     localStorage.setItem("loginDetails", JSON.stringify(this.loginForm.value))
  }

  validateDoctorLogin() {
    this.errorMessage ="";
    if (this.loginForm.valid) {
      this.config.validateDoctorLogin(this.loginForm.get('UserName').value,this.loginForm.get('Password').value,this.loginForm.get('Location').value).subscribe((response) => {
        if (response.length === 0) {
          this.errorMessage = "Invalid UserName / Password"
        } else if (response[0].CredentialsMessage) {
          this.errorMessage = "Invalid UserName / Password"
        }
        else {
          localStorage.setItem("doctorDetails", JSON.stringify(response))
          localStorage.setItem("hospitalId", this.loginForm.get('Location').value)
          localStorage.setItem("isLoggedIn", 'true');
          this.location =  this.locationList.filter((a: any) => a.HospitalID == this.loginForm.get('Location').value)[0].Name;
          localStorage.setItem("location", this.location)
          this.router.navigate(['/home/patients'])
        }
      },
        (err) => {

        })
    }
  }
 
  backToLogin() {
    this.showLogin = true;
  }
  
  selectedLanguage(lang: any) {
    this.selectedLang = lang;
    localStorage.setItem("lang", `${this.selectedLang.code}`);
    this.loader.setDefaultLangCode(this.selectedLang.code);
    this.getSelectedLangData(this.selectedLang.code);
    this.getDate(this.selectedLang.code);
  }
  startTimer() {
    this.interval = setInterval(() => {
      if (this.timeLeft > 0) {
        this.timeLeft--;
      } else {
        this.timeLeft = 60;
      }
      if (this.timeLeft == 0) {
        this.pauseTimer();
      }
    }, 1000)
  }

  pauseTimer() {
    clearInterval(this.interval);
    this.showResendOTP = true;
  }
  showToastrModal() {
    $("#otpMessage").modal('show');
  }
  closeToastr() {
    $("#otpMessage").modal('hide');
  }
  // showOtpFailModal() {
  //   $("#otpFail").modal('show');
  // }
  // closeOtpFailModal() {
  //   $("#otpFail").modal('hide');
  // }
  getSelectedLangData(lang: any) {
    this.config.getSelectedLang(lang).subscribe((response: any) => {
      this.loginLangData = response;
      localStorage.setItem("langData", JSON.stringify(this.loginLangData))
    });
  }
  getDate(langCode: any) {
    if (langCode === "en") {
      this.currentdate = moment(new Date()).format('DD-MMM-YYYY, hh:mm A');
    } else if (langCode === "ar") {
    }
  }
  
  
}